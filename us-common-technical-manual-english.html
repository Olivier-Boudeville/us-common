<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<title>Welcome to the US-Common documentation</title>
<meta content="US-Common" name="keywords" />
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="us-common.css" type="text/css" />
<link href="us-common-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document" id="technical-manual-of-the-us-common-layer">
<h1 class="title">Technical Manual of the <tt class="docutils literal"><span class="pre">US-Common</span></tt> Layer</h1>

<span class="target" id="top"></span><p><span class="raw-html"><a name="us-common_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>US-Common documentation</em> <a href="http://us-common.esperide.org">browse latest</a> <a href="https://olivier-boudeville.github.io/us-common/index.html">browse mirror</a> <a href="us-common-technical-manual-english.pdf">get PDF</a> <a href="#us-common_top">go to top</a> <a href="#us-common_toc">go to toc</a> <a href="#us-common_bottom">go to bottom</a> <a href="api-doc/index.html">browse API</a> <a href="https://github.com/Olivier-Boudeville/us-common">go to project</a> <a href="mailto:about(dash)us-common(at)esperide(dot)com?subject=[US-Common]%20Remark">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="us-common-title.png" width="40%"></img></span>
</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body"><p class="first">Copyright (C) 2019-2023 Olivier Boudeville</p>
</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body"><p class="first">about (dash) us-common (at) esperide (dot) com</p>
</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body"><p class="first">Saturday, May 2, 2020</p>
</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body"><p class="first">Sunday, January 1, 2023</p>
</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body"><p class="first">0.0.9</p>
</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body"><p class="first">Stable</p>
</td>
</tr>
<tr class="field"><th class="field-name">Dedication:</th><td class="field-body"><p class="first">Users and maintainers of the <tt class="docutils literal"><span class="pre">US-Common</span></tt> layer.</p>
</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body"><p class="first">The role of the <a class="reference external" href="http://us-common.esperide.org/">US-Common</a> layer (part of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">Universal Server</a> project) is to provide base elements on which the various <em>Universal Services</em> are built, notably:</p>
<ul class="simple">
<li>the Universal Server itself: see <a class="reference external" href="http://us-main.esperide.org/">US-Main</a></li>
<li>the Universal Webserver: see <a class="reference external" href="http://us-web.esperide.org/">US-Web</a></li>
</ul>
<p>We present here a short overview of these services, to introduce them to newcomers.</p>
<p class="last">The next level of information is either to browse the <a class="reference external" href="api-doc/index.html">US-Common API documentation</a> or simply to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/tree/master/src">source files</a>, which are intensely commented and generally straightforward.</p>
</td>
</tr>
</tbody>
</table>
<p><span class="raw-html"></center></span></p>
<p>The latest version of this documentation is to be found at the <a class="reference external" href="http://us-common.esperide.org">official US-Common website</a> (<tt class="docutils literal"><span class="pre">http://us-common.esperide.org</span></tt>).</p>
<p><span class="raw-html">This US-Common documentation is also available in the PDF format (see <a href="us-common-technical-manual-english.pdf">us-common-Layer-technical-manual-english.pdf</a>), and mirrored <a href="https://olivier-boudeville.github.io/us-common/">here</a>.</span></p>
<p></p>
<p></p>
<p><span class="raw-html"><a name="us-common_toc"></a></span></p>
<div class="contents topic" id="topic-1">
<span id="table-of-contents"></span><p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="toc-entry-1">Overview</a></li>
<li><a class="reference internal" href="#layer-stack" id="toc-entry-2">Layer Stack</a></li>
<li><a class="reference internal" href="#facilities-provided-by-this-layer" id="toc-entry-3">Facilities Provided by this Layer</a></li>
<li><a class="reference internal" href="#configuration" id="toc-entry-4">Configuration</a><ul>
<li><a class="reference internal" href="#server-configuration" id="toc-entry-5">Server Configuration</a></li>
<li><a class="reference internal" href="#client-configuration" id="toc-entry-6">Client Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#licence" id="toc-entry-7">Licence</a></li>
<li><a class="reference internal" href="#current-stable-version-download" id="toc-entry-8">Current Stable Version &amp; Download</a><ul>
<li><a class="reference internal" href="#using-cutting-edge-git" id="toc-entry-9">Using Cutting-Edge GIT</a></li>
<li><a class="reference internal" href="#using-otp-related-build-runtime-conventions" id="toc-entry-10">Using OTP-Related Build/Runtime Conventions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#support" id="toc-entry-11">Support</a></li>
<li><a class="reference internal" href="#please-react" id="toc-entry-12">Please React!</a></li>
<li><a class="reference internal" href="#ending-word" id="toc-entry-13">Ending Word</a></li>
</ul>
</div>
<p></p>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#toc-entry-1">Overview</a></h1>
<p>The <a class="reference external" href="http://us-common.esperide.org/">US-Common</a> layer is the basis (lowest-level) of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">Universal Server</a> project.</p>
<p>Its purpose is to provide base elements on which the various <em>Universal Services</em> are built, notably:</p>
<ul class="simple">
<li>the Universal Server itself: see <a class="reference external" href="http://us.esperide.org/">US-Main</a></li>
<li>the Universal Webserver: see <a class="reference external" href="http://us-web.esperide.org/">US-Web</a></li>
</ul>
<p>We present here a short overview of these services, to introduce them to newcomers.</p>
<p>The next level of information is to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/tree/master/src">source files</a>, which are intensely commented and generally straightforward.</p>
<p>The project repository is located <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common">here</a>.</p>
</div>
<div class="section" id="layer-stack">
<h1><a class="toc-backref" href="#toc-entry-2">Layer Stack</a></h1>
<p>From the highest level to the lowest, as shown <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">here</a>, usually a software stack involving US-Common is structured that way:</p>
<ul class="simple">
<li>an applicative layer such as <a class="reference external" href="http://us-main.esperide.org/">US-Main</a> or <a class="reference external" href="http://us-web.esperide.org/">US-Web</a>, etc.</li>
<li><a class="reference external" href="http://us-common.esperide.org/">US-Common</a> (this layer)</li>
<li><a class="reference external" href="http://traces.esperide.org">Ceylan-Traces</a> (for advanced runtime traces)</li>
<li><a class="reference external" href="http://wooper.esperide.org">Ceylan-WOOPER</a> (for OOP)</li>
<li><a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a> (as an Erlang toolbox)</li>
<li><a class="reference external" href="http://erlang.org">Erlang</a> (for the compiler and runtime)</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Linux">GNU/Linux</a></li>
</ul>
<p>The shorthand for <tt class="docutils literal"><span class="pre">US-Common</span></tt> is <tt class="docutils literal">uc</tt>.</p>
<p></p>
</div>
<div class="section" id="facilities-provided-by-this-layer">
<h1><a class="toc-backref" href="#toc-entry-3">Facilities Provided by this Layer</a></h1>
<p>These are mainly common services centralised here so that the various US applications can make use of them:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USServer.erl">USServer</a>: a general <strong>abstraction of a server</strong>, so that all US ones inherit the corresponding base features (ex: name registration, uptime information, applicative ping, state description, etc.)</li>
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USConfigServer.erl">USConfigServer</a>: a server (usually a singleton) in charge of <strong>managing all US-level configuration information</strong> on behalf of the other US servers; this comprises the look-up, parsing and checking of the relevant configuration files, the setting of the corresponding information then made available to the rest of the US framework (EPMD port, TCP port range, cookie, execution context, application and log directories, name and scope of registrations, user/group information, etc.)</li>
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USScheduler.erl">USScheduler</a>: a server whose purpose is to <strong>schedule any kind of asynchronous, independent tasks</strong> (think: &quot;crontab on steroids&quot;); it allows planning task commands to be issued to actuators one time, multiple ones, or indefinitely, based on user-level periods with various policies, on a best-effort basis yet reliably (proper time and timer management), trying to find a balance between the respect of the requested periodicities and the correction of any delay incurred (see also a <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/test/class_USScheduler_test.erl">corresponding test</a> of it)</li>
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/src/class_USTaskRing.erl">USTaskRing</a>: a facility useful to <strong>schedule a set of periodic tasks synchronously</strong> (no overlapping between them) <strong>and uniformly</strong> (as evenly as possible over time); typically useful to pace regularly a set of actions of indefinite number that are ruled by a common periodicity and/or to share a resource unable to cope with concurrent accesses (ex: a non-reentrant third-party log analysis tool that maintains its own opaque state on filesystem, yet have to operate on a set of virtual hosts)</li>
</ul>
</div>
<div class="section" id="configuration">
<h1><a class="toc-backref" href="#toc-entry-4">Configuration</a></h1>
<div class="section" id="server-configuration">
<h2><a class="toc-backref" href="#toc-entry-5">Server Configuration</a></h2>
<p id="us-configuration-directory">The configuration of the Universal Server infrastructure lies primarily in a dedicated <tt class="docutils literal">us.config</tt> file, which is searched from various base directories, according to the following order:</p>
<ol class="arabic simple">
<li>in any base directory designated by the standard <tt class="docutils literal">XDG_CONFIG_HOME</tt> environment variable, otherwise in default <tt class="docutils literal"><span class="pre">~/.config</span></tt></li>
<li>in any of the base directories listed (separator being <tt class="docutils literal">:</tt>) in the standard <tt class="docutils literal">XDG_CONFIG_DIRS</tt> environment variable, otherwise in default <tt class="docutils literal">/etc/xdg</tt></li>
</ol>
<p>Each of these base directories is searched in turn for a <tt class="docutils literal"><span class="pre">universal-server</span></tt> subdirectory that would contain a <tt class="docutils literal">us.config</tt> file, and the first found one is chosen as the <strong>US Configuration directory</strong>. Any other US-related configuration file is then expected to be found in the same directory.</p>
<p>In practice, often the <tt class="docutils literal"><span class="pre">~/.config/universal-server/us.config</span></tt> location is preferred.</p>
<p>All US configuration files are in the <a class="reference external" href="http://myriad.esperide.org/#etf">ETF</a> format (for <em>Erlang Term Format</em>).</p>
<p>One may refer to <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">this example us.config</a> to learn their structure and derive one's own <tt class="docutils literal">us.config</tt>.</p>
</div>
<div class="section" id="client-configuration">
<h2><a class="toc-backref" href="#toc-entry-6">Client Configuration</a></h2>
<p>Each US service (ex: <tt class="docutils literal"><span class="pre">US-Main</span></tt>, <tt class="docutils literal"><span class="pre">US-Web</span></tt>, etc.) can be monitored (locally or remotely) thanks to a corresponding <tt class="docutils literal"><span class="pre">priv/bin/monitor-us-*.sh</span></tt> script, which must be given the necessary information (hostname, cookie, TCP port range, etc.) in order to contact the target US instance.</p>
<p>This information is typically stored in a <tt class="docutils literal"><span class="pre">us-*-remote-access.config</span></tt> ETF file, located as well in the aforementioned <a class="reference internal" href="#us-configuration-directory">US configuration directory</a>.</p>
</div>
</div>
<div class="section" id="licence">
<span id="free-software"></span><h1><a class="toc-backref" href="#toc-entry-7">Licence</a></h1>
<p><tt class="docutils literal"><span class="pre">US-Common</span></tt> is licensed by its author (Olivier Boudeville) under the <a class="reference external" href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU Affero General Public License</a> as published by the Free Software Foundation, either version 3 of this license, or (at your option) any later version.</p>
<p>This allows the use of the US-Common code in a wide a variety of software projects, while still maintaining copyleft on this code, ensuring improvements are shared.</p>
<p>We hope indeed that enhancements will be back-contributed (ex: thanks to merge requests), so that everyone will be able to benefit from them.</p>
</div>
<div class="section" id="current-stable-version-download">
<h1><a class="toc-backref" href="#toc-entry-8">Current Stable Version &amp; Download</a></h1>
<p>In general, we prefer using GNU/Linux, sticking to the latest stable release of Erlang, and building it from sources, thanks to GNU <tt class="docutils literal">make</tt>.</p>
<p>As mentioned, the single, direct prerequisite of <a class="reference external" href="https://github.com/Olivier-Boudeville/US-Common">US-Common</a> is <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Traces">Ceylan-Traces</a>, which implies in turn <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-WOOPER">Ceylan-WOOPER</a>, then <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad">Ceylan-Myriad</a> and <a class="reference external" href="http://erlang.org">Erlang</a>.</p>
<p>Refer to the corresponding <a class="reference external" href="http://myriad.esperide.org#prerequisites">Myriad prerequisite section</a>  for more precise guidelines, knowing that US-Common does not need modules with conditional support such as <tt class="docutils literal">crypto</tt> or <tt class="docutils literal">wx</tt>.</p>
<p>Most uses of US-Common will require <tt class="docutils literal">authbind</tt> (ex: on Arch Linux, obtained from the AUR, typically with thanks to the AUR installer that <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/update-aur-installer.sh">Ceylan-Hull recommends and installs</a> ).</p>
<div class="section" id="using-cutting-edge-git">
<h2><a class="toc-backref" href="#toc-entry-9">Using Cutting-Edge GIT</a></h2>
<p>This is the installation method that we use and recommend; the US-Common <tt class="docutils literal">master</tt> branch is meant to stick to the latest stable version: we try to ensure that this main line always stays functional (sorry for the pun). Evolutions are to take place in feature branches and to be merged only when ready.</p>
<p>Once Erlang is available, it should be just a matter of executing:</p>
<pre class="code bash literal-block">
$ git clone https://github.com/Olivier-Boudeville/Ceylan-Myriad myriad
$ <span class="nb">cd</span> myriad <span class="o">&amp;&amp;</span> make all <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ..

$ git clone https://github.com/Olivier-Boudeville/Ceylan-WOOPER wooper
$ <span class="nb">cd</span> wooper <span class="o">&amp;&amp;</span> make all <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ..

$ git clone https://github.com/Olivier-Boudeville/Ceylan-Traces traces
$ <span class="nb">cd</span> traces <span class="o">&amp;&amp;</span> make all <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ..

<span class="c1"># Note the dash becoming an underscore, for OTP compliance:
</span>$ git clone https://github.com/Olivier-Boudeville/us-common us_common
$ <span class="nb">cd</span> us_common <span class="o">&amp;&amp;</span> make all
</pre>
<p>Running a corresponding test just then boils down to:</p>
<pre class="code bash literal-block">
$ <span class="nb">cd</span> <span class="nb">test</span> <span class="o">&amp;&amp;</span> make class_USScheduler_run <span class="nv">CMD_LINE_OPT</span><span class="o">=</span><span class="s2">&quot;--batch&quot;</span>
</pre>
<p>Should LogMX be installed and available in the PATH, the test may simply become:</p>
<pre class="code bash literal-block">
$ make class_USScheduler_run
</pre>
<p><span class="raw-html"><a name="otp"></a></span></p>
</div>
<div class="section" id="using-otp-related-build-runtime-conventions">
<span id="otp-build"></span><h2><a class="toc-backref" href="#toc-entry-10">Using OTP-Related Build/Runtime Conventions</a></h2>
<p>As discussed in these sections of <a class="reference external" href="http://myriad.esperide.org/myriad.html#otp">Myriad</a>, <a class="reference external" href="http://wooper.esperide.org/index.html#otp">WOOPER</a> and <a class="reference external" href="http://traces.esperide.org/index.html#otp">Traces</a>, we added the (optional) possibility of generating a US-Common <em>OTP application</em> out of the build tree, ready to be integrated into an <em>(OTP) release</em>. For that we rely on <a class="reference external" href="https://www.rebar3.org/">rebar3</a>, <a class="reference external" href="https://github.com/erlware/relx">relx</a> and <a class="reference external" href="https://hex.pm/">hex</a>.</p>
<p>Unlike Myriad (which is an OTP <em>library</em> application), US-Common is (like WOOPER and Traces) an OTP <em>active</em> application, meaning the reliance on an application that can be started/stopped (<tt class="docutils literal">us_common_app</tt>), a root supervisor (<tt class="docutils literal">us_common_sup</tt>) and, here, two proper supervisor bridges (<tt class="docutils literal">us_common_scheduler_bridge_sup</tt> and <tt class="docutils literal">us_common_config_bridge_sup</tt>).</p>
</div>
</div>
<div class="section" id="support">
<h1><a class="toc-backref" href="#toc-entry-11">Support</a></h1>
<p>Bugs, questions, remarks, patches, requests for enhancements, etc. are to be reported to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common">project interface</a> (typically <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/issues">issues</a>) or directly at the email address mentioned at the beginning of this document.</p>
</div>
<div class="section" id="please-react">
<h1><a class="toc-backref" href="#toc-entry-12">Please React!</a></h1>
<p>If you have information more detailed or more recent than those presented in this document, if you noticed errors, neglects or points insufficiently discussed, drop us a line! (for that, follow the <a class="reference internal" href="#support">Support</a> guidelines).</p>
</div>
<div class="section" id="ending-word">
<h1><a class="toc-backref" href="#toc-entry-13">Ending Word</a></h1>
<p>Have fun with US-Common!</p>
<p><span class="raw-html"><center><img src="us-common-title.png" width="25%"></img></center></span>
</p>
<p><span class="raw-html"><a name="us-common_bottom"></a></span></p>
</div>
</div>
</body>
</html>
